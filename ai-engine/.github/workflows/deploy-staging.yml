# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AI Engine â€” Deploy to Staging
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Triggers on push to main branch.
# Deploys to staging environment with health check validation.
#
# âš ï¸ REQUIRED GITHUB SECRETS (set in repo settings):
#   - CLOUDFLARE_API_TOKEN: Cloudflare API token with Workers deploy permission
#   - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
#   - CLOUDFLARE_WORKER_SUBDOMAIN: Worker subdomain (e.g., "ai-engine")
#   - AI_ENGINE_TOKEN: Shared auth token (â‰¥40 chars)
#   - ANTHROPIC_API_KEY: Claude API key (sk-ant-...)
#   - OPENAI_API_KEY: OpenAI API key (optional)
#   - GOOGLE_AI_API_KEY: Google Gemini API key (optional)
#   - MISTRAL_API_KEY: Mistral API key (optional)
#   - DEEPSEEK_API_KEY: DeepSeek API key (optional)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy to Staging

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  check-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    outputs:
      missing: ${{ steps.validate.outputs.missing }}
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Validate GitHub Secrets
        id: validate
        run: |
          # Define required secrets
          REQUIRED=("CLOUDFLARE_API_TOKEN" "CLOUDFLARE_ACCOUNT_ID" "CLOUDFLARE_WORKER_SUBDOMAIN" "AI_ENGINE_TOKEN" "ANTHROPIC_API_KEY")
          OPTIONAL=("OPENAI_API_KEY" "GOOGLE_AI_API_KEY" "MISTRAL_API_KEY" "DEEPSEEK_API_KEY")

          MISSING=()
          FOUND=()

          echo "Checking required secrets..."
          for secret in "${REQUIRED[@]}"; do
            eval "value=\$$secret"
            if [ -z "$value" ]; then
              MISSING+=("$secret")
              echo "  âŒ $secret â€” NOT SET"
            else
              FOUND+=("$secret")
              echo "  âœ… $secret â€” configured"
            fi
          done

          echo ""
          echo "Checking optional provider keys..."
          PROVIDER_COUNT=1  # Cloudflare is always available
          for secret in "${OPTIONAL[@]}"; do
            eval "value=\$$secret"
            if [ -z "$value" ]; then
              echo "  âšª $secret â€” not configured (optional)"
            else
              PROVIDER_COUNT=$((PROVIDER_COUNT + 1))
              echo "  âœ… $secret â€” configured"
            fi
          done

          # Anthropic check (if ANTHROPIC_API_KEY is set, it's configured)
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            PROVIDER_COUNT=$((PROVIDER_COUNT + 1))
          fi

          echo ""
          echo "Summary:"
          echo "  Total AI Providers available: $PROVIDER_COUNT"
          echo "  Required secrets found: ${#FOUND[@]}/${#REQUIRED[@]}"

          # Set outputs for workflow
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "missing=" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… All required secrets configured!"
            exit 0
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "missing=$(IFS=, ; echo "${MISSING[*]}" )" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ Missing required secrets:"
            for secret in "${MISSING[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ðŸ“‹ To fix: Set these secrets in GitHub repo settings (Settings â†’ Secrets and variables â†’ Actions)"
            echo "   Example: https://github.com/reponame/settings/secrets/actions"
            echo ""
            echo "Required secrets to configure:"
            echo "  1. CLOUDFLARE_API_TOKEN â€” Get from https://dash.cloudflare.com/profile/api-tokens"
            echo "  2. CLOUDFLARE_ACCOUNT_ID â€” Found in Cloudflare Workers dashboard"
            echo "  3. CLOUDFLARE_WORKER_SUBDOMAIN â€” Your worker subdomain (e.g., 'ai-engine')"
            echo "  4. AI_ENGINE_TOKEN â€” Create a secure token (40+ chars, alphanumeric)"
            echo "  5. ANTHROPIC_API_KEY â€” Get from https://console.anthropic.com/settings/keys"
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}
          AI_ENGINE_TOKEN: ${{ secrets.AI_ENGINE_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  test:
    name: Run Tests
    needs: check-secrets
    if: needs.check-secrets.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: |
          npm ci || npm install --no-save

      - run: npm test

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: |
          npm ci || npm install --no-save

      - name: Ensure Wrangler v4 is available
        run: |
          echo "Installing Wrangler v4 in the runner (local install; will not modify package.json)"
          npm install --no-save wrangler@4

      - name: KV namespace check (auto-create if missing)
        run: |
          node scripts/check-or-create-kv.mjs --env staging --create --patch
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Authenticate with Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4'
          command: whoami --config config/wrangler.toml --env staging

      - name: Upload Secrets to Cloudflare (Staging)
        run: |
          set -euo pipefail
          echo "Uploading Cloudflare secrets for staging..."

          if [ -n "${{ secrets.AI_ENGINE_TOKEN }}" ]; then
            echo " - AI_ENGINE_TOKEN"
            echo "${{ secrets.AI_ENGINE_TOKEN }}" | npx wrangler secret put AI_ENGINE_TOKEN --config config/wrangler.toml --env staging
          else
            echo " - AI_ENGINE_TOKEN (skipped)"
          fi

          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo " - ANTHROPIC_API_KEY"
            echo "${{ secrets.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY --config config/wrangler.toml --env staging
          else
            echo " - ANTHROPIC_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo " - OPENAI_API_KEY"
            echo "${{ secrets.OPENAI_API_KEY }}" | npx wrangler secret put OPENAI_API_KEY --config config/wrangler.toml --env staging
          else
            echo " - OPENAI_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.GOOGLE_AI_API_KEY }}" ]; then
            echo " - GOOGLE_AI_API_KEY"
            echo "${{ secrets.GOOGLE_AI_API_KEY }}" | npx wrangler secret put GOOGLE_AI_API_KEY --config config/wrangler.toml --env staging
          else
            echo " - GOOGLE_AI_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.MISTRAL_API_KEY }}" ]; then
            echo " - MISTRAL_API_KEY"
            echo "${{ secrets.MISTRAL_API_KEY }}" | npx wrangler secret put MISTRAL_API_KEY --config config/wrangler.toml --env staging
          else
            echo " - MISTRAL_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
            echo " - DEEPSEEK_API_KEY"
            echo "${{ secrets.DEEPSEEK_API_KEY }}" | npx wrangler secret put DEEPSEEK_API_KEY --config config/wrangler.toml --env staging
          else
            echo " - DEEPSEEK_API_KEY (skipped)"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Diagnostic â€” Cloudflare account & KV namespaces
        run: |
          echo "Whoami:"; npx wrangler whoami --config config/wrangler.toml || true
          echo "KV namespaces (account):"; npx wrangler kv namespace list --config config/wrangler.toml --env staging || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers (Staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4'
          command: deploy --config config/wrangler.toml --env staging

      - name: Post-deploy Health Check
        run: |
          echo "Waiting 10s for deployment to propagate..."
          sleep 10

          SUBDOMAIN="$WORKER_SUBDOMAIN"
          HEALTH_URL="https://ai-engine-staging.${SUBDOMAIN}.workers.dev/health"
          echo "Checking: $HEALTH_URL"

          HTTP_CODE=$(curl -s -o /tmp/health-response.json -w "%{http_code}" "$HEALTH_URL" 2>/dev/null || echo "000")
          RESPONSE=$(cat /tmp/health-response.json 2>/dev/null || echo '{}')

          echo "HTTP Status: $HTTP_CODE"
          echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Staging deployment healthy"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "::warning::Health check could not reach the worker (DNS may still be propagating)"
          else
            echo "::warning::Staging health check returned HTTP $HTTP_CODE â€” worker deployed but may need debugging"
            echo "Response: $RESPONSE"
          fi
        env:
          WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}
