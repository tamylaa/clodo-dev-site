# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AI Engine â€” Deploy to Production
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Triggers on:
#   1. Manual dispatch (workflow_dispatch) â€” for controlled releases
#   2. Release tags (v*.*.*)
# Includes staging validation, production deploy, and health checks.#
# âš ï¸ REQUIRED GITHUB SECRETS (set in repo settings):
#   - CLOUDFLARE_API_TOKEN: Cloudflare API token with Workers deploy permission
#   - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
#   - CLOUDFLARE_WORKER_SUBDOMAIN: Worker subdomain (e.g., "ai-engine")
#   - AI_ENGINE_TOKEN: Shared auth token (â‰¥40 chars)
#   - ANTHROPIC_API_KEY: Claude API key (sk-ant-...)
#   - OPENAI_API_KEY: OpenAI API key (sk-...)
#   - GOOGLE_AI_API_KEY: Google Gemini API key (optional)
#   - MISTRAL_API_KEY: Mistral API key (optional)
#   - DEEPSEEK_API_KEY: DeepSeek API key (optional)# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_staging_check:
        description: 'Skip staging health check?'
        required: false
        default: 'false'

jobs:
  check-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    outputs:
      missing: ${{ steps.validate.outputs.missing }}
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Validate GitHub Secrets (Production)
        id: validate
        run: |
          # Production requires ALL secrets to be configured
          REQUIRED=("CLOUDFLARE_API_TOKEN" "CLOUDFLARE_ACCOUNT_ID" "CLOUDFLARE_WORKER_SUBDOMAIN" "AI_ENGINE_TOKEN" "ANTHROPIC_API_KEY")
          OPTIONAL=("OPENAI_API_KEY" "GOOGLE_AI_API_KEY" "MISTRAL_API_KEY" "DEEPSEEK_API_KEY")

          MISSING=()
          FOUND=()

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ” Production Deployment â€” Secret Validation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Checking REQUIRED secrets for production..."
          for secret in "${REQUIRED[@]}"; do
            eval "value=\$$secret"
            if [ -z "$value" ]; then
              MISSING+=("$secret")
              echo "  âŒ $secret â€” NOT SET"
            else
              FOUND+=("$secret")
              echo "  âœ… $secret â€” configured"
            fi
          done

          echo ""
          echo "Checking OPTIONAL provider keys..."
          PROVIDER_COUNT=1  # Cloudflare Workers AI is always available
          for secret in "${OPTIONAL[@]}"; do
            eval "value=\$$secret"
            if [ -z "$value" ]; then
              echo "  âšª $secret â€” not configured (optional fallback)"
            else
              PROVIDER_COUNT=$((PROVIDER_COUNT + 1))
              echo "  âœ… $secret â€” configured"
            fi
          done

          # Add Anthropic if it's set
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            PROVIDER_COUNT=$((PROVIDER_COUNT + 1))
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Summary:"
          echo "  Total AI providers available: $PROVIDER_COUNT (1 free + configured keys)"
          echo "  Required secrets: ${#FOUND[@]}/${#REQUIRED[@]} configured"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Set outputs for workflow
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "missing=" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… Production deployment authorized â€” all required secrets present!"
            exit 0
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "missing=$(IFS=, ; echo "${MISSING[*]}" )" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ›ž PRODUCTION DEPLOYMENT BLOCKED"
            echo ""
            echo "Missing required secrets:"
            for secret in "${MISSING[@]}"; do
              echo "   â†’ $secret"
            done
            echo ""
            echo "ðŸ“‹ INSTRUCTIONS TO FIX:"
            echo ""
            echo "1. Open: https://github.com/$GITHUB_REPOSITORY/settings/secrets/actions"
            echo ""
            echo "2. Create/update these secrets:"
            echo ""
            for secret in "${MISSING[@]}"; do
              case $secret in
                CLOUDFLARE_API_TOKEN)
                  echo "   â¬ƒ $secret"
                  echo "      â†’ Go to: https://dash.cloudflare.com/profile/api-tokens"
                  echo "      â†’ Create token with 'Workers Scripts' permissions"
                  echo ""
                  ;;
                CLOUDFLARE_ACCOUNT_ID)
                  echo "   â¬ƒ $secret"
                  echo "      â†’ Go to: https://dash.cloudflare.com/workers"
                  echo "      â†’ Copy your Account ID (sidebar)"
                  echo ""
                  ;;
                CLOUDFLARE_WORKER_SUBDOMAIN)
                  echo "   â¬ƒ $secret"
                  echo "      â†’ Choose subdomain for your worker (e.g., 'ai-engine')"
                  echo "      â†’ Will be: https://ai-engine-production.subdomain.workers.dev"
                  echo ""
                  ;;
                AI_ENGINE_TOKEN)
                  echo "   â¬ƒ $secret"
                  echo "      â†’ Generate secure token: openssl rand -hex 20"
                  echo "      â†’ Minimum 40 characters recommended"
                  echo ""
                  ;;
                ANTHROPIC_API_KEY)
                  echo "   â¬ƒ $secret (REQUIRED)"
                  echo "      â†’ Go to: https://console.anthropic.com/settings/keys"
                  echo "      â†’ Create new API key"
                  echo "      â†’ Copy: sk-ant-..."
                  echo ""
                  ;;
              esac
            done
            echo "3. Retry the workflow after secrets are configured"
            echo ""
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}
          AI_ENGINE_TOKEN: ${{ secrets.AI_ENGINE_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  test:
    name: Run Tests
    needs: check-secrets
    if: needs.check-secrets.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: |
          npm ci || npm install --no-save
      - run: npm test

  check-staging:
    name: Verify Staging Health
    needs: [test, check-secrets]
    if: needs.check-secrets.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check staging is healthy
        run: |
          SUBDOMAIN="$WORKER_SUBDOMAIN"
          HEALTH_URL="https://ai-engine-staging.${SUBDOMAIN}.workers.dev/health"
          echo "Verifying staging at: $HEALTH_URL"

          RESPONSE=$(curl -sf "$HEALTH_URL" 2>/dev/null || echo '{"healthy":false}')
          HEALTHY=$(echo "$RESPONSE" | jq -r '.healthy // false')

          if [ "$HEALTHY" != "true" ]; then
            echo "::error::Staging is unhealthy â€” deploy to staging first!"
            echo "Response: $RESPONSE"
            exit 1
          fi
          echo "âœ… Staging is healthy"
        env:
          WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}

  deploy-production:
    name: Deploy to Production
    needs: [test, check-staging]
    if: always() && needs.test.result == 'success' && (needs.check-staging.result == 'success' || needs.check-staging.result == 'skipped')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: |
          npm ci || npm install --no-save

      - name: Ensure Wrangler v4 is available
        run: |
          echo "Installing Wrangler v4 in the runner (local install; will not modify package.json)"
          npm install --no-save wrangler@4

      - name: KV namespace check (auto-create if missing)
        run: |
          node scripts/check-or-create-kv.mjs --env production --create --patch
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Authenticate with Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4'
          command: whoami --config config/wrangler.toml --env production

      - name: Upload Secrets to Cloudflare (Production)
        run: |
          set -euo pipefail
          echo "Uploading Cloudflare secrets for production..."

          if [ -n "${{ secrets.AI_ENGINE_TOKEN }}" ]; then
            echo " - AI_ENGINE_TOKEN"
            echo "${{ secrets.AI_ENGINE_TOKEN }}" | npx wrangler secret put AI_ENGINE_TOKEN --config config/wrangler.toml --env production
          else
            echo " - AI_ENGINE_TOKEN (skipped)"
          fi

          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo " - ANTHROPIC_API_KEY"
            echo "${{ secrets.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY --config config/wrangler.toml --env production
          else
            echo " - ANTHROPIC_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo " - OPENAI_API_KEY"
            echo "${{ secrets.OPENAI_API_KEY }}" | npx wrangler secret put OPENAI_API_KEY --config config/wrangler.toml --env production
          else
            echo " - OPENAI_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.GOOGLE_AI_API_KEY }}" ]; then
            echo " - GOOGLE_AI_API_KEY"
            echo "${{ secrets.GOOGLE_AI_API_KEY }}" | npx wrangler secret put GOOGLE_AI_API_KEY --config config/wrangler.toml --env production
          else
            echo " - GOOGLE_AI_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.MISTRAL_API_KEY }}" ]; then
            echo " - MISTRAL_API_KEY"
            echo "${{ secrets.MISTRAL_API_KEY }}" | npx wrangler secret put MISTRAL_API_KEY --config config/wrangler.toml --env production
          else
            echo " - MISTRAL_API_KEY (skipped)"
          fi

          if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
            echo " - DEEPSEEK_API_KEY"
            echo "${{ secrets.DEEPSEEK_API_KEY }}" | npx wrangler secret put DEEPSEEK_API_KEY --config config/wrangler.toml --env production
          else
            echo " - DEEPSEEK_API_KEY (skipped)"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Diagnostic â€” Cloudflare account & KV namespaces
        run: |
          echo "Whoami:"; npx wrangler whoami --config config/wrangler.toml || true
          echo "KV namespaces (account):"; npx wrangler kv namespace list --config config/wrangler.toml --env production || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4'
          command: deploy --config config/wrangler.toml --env production

      - name: Post-deploy Health Check
        run: |
          echo "Waiting 15s for production deployment to propagate..."
          sleep 15

          SUBDOMAIN="$WORKER_SUBDOMAIN"
          HEALTH_URL="https://ai-engine.${SUBDOMAIN}.workers.dev/health"
          echo "Checking: $HEALTH_URL"

          HTTP_CODE=$(curl -s -o /tmp/health-response.json -w "%{http_code}" "$HEALTH_URL" 2>/dev/null || echo "000")
          RESPONSE=$(cat /tmp/health-response.json 2>/dev/null || echo '{}')

          echo "HTTP Status: $HTTP_CODE"
          echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Production deployment healthy"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "::warning::Health check could not reach the worker (DNS may still be propagating)"
          else
            echo "::warning::Production health check returned HTTP $HTTP_CODE â€” worker deployed but may need debugging"
            echo "Response: $RESPONSE"
          fi
        env:
          WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}

      - name: Verify Provider Availability
        run: |
          SUBDOMAIN="$WORKER_SUBDOMAIN"
          CAP_URL="https://ai-engine.${SUBDOMAIN}.workers.dev/ai/providers"
          echo "Verifying: $CAP_URL"

          RESPONSE=$(curl -sf -H "x-ai-engine-service: ${TOKEN}" "$CAP_URL" 2>/dev/null || echo '{}')
          echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"

          PROVIDERS=$(echo "$RESPONSE" | jq -r '.providers | length // 0' 2>/dev/null || echo "0")
          echo "Available providers: $PROVIDERS"

          if [ "$PROVIDERS" -lt 1 ]; then
            echo "::warning::No AI providers available! Check secrets are set in Cloudflare."
          else
            echo "âœ… Production is configured with $PROVIDERS AI providers"
          fi
        env:
          WORKER_SUBDOMAIN: ${{ secrets.CLOUDFLARE_WORKER_SUBDOMAIN }}
          TOKEN: ${{ secrets.AI_ENGINE_TOKEN }}
