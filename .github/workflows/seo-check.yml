name: SEO Checker - Automated Scan

on:
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC
  workflow_dispatch: {}

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Generate SEO URL list from sitemap
        run: |
          echo "Generating data/seo-urls.txt from public/sitemap.xml"
          mkdir -p data
          node -e "const fs=require('fs'); const xml=fs.readFileSync('public/sitemap.xml','utf8'); const urls=[...xml.matchAll(/<loc>([^<]+)<\/loc>/g)].map(m=>m[1]); fs.writeFileSync('data/seo-urls.txt', urls.join('\n')); console.log('Wrote', urls.length, 'URLs')"

      - name: Run SEO check
        run: |
          echo "üîç Running SEO checker on $(wc -l < data/seo-urls.txt || echo '?') URLs..."
          node scripts/seo/seo-checker.mjs --input data/seo-urls.txt --config config/seo-checker.json --output reports/seo-report-${{ github.run_id }}.csv
          echo "‚úÖ SEO check complete"
      
      - name: Run canonical consistency check
        run: |
          echo "üîó Checking canonical consistency..."
          REPORT_JSON=reports/seo-report-${{ github.run_id }}.json
          if [ ! -f "$REPORT_JSON" ]; then echo "Expected report not found: $REPORT_JSON"; exit 1; fi
          node scripts/seo/check-canonical-consistency.mjs "$REPORT_JSON"
          echo "‚úÖ Canonical check complete"
      
      - name: Generate priority fixes report
        run: |
          echo "üìä Generating priority fixes report..."
          if [ -f "reports/generate-priority-fixes.mjs" ]; then
            node reports/generate-priority-fixes.mjs
            echo "‚úÖ Priority fixes report generated"
          else
            echo "‚ö†Ô∏è Skipping: reports/generate-priority-fixes.mjs not found"
          fi
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üîç SEO Checker Automated Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/seo-canonical-mismatches.md" ]; then
            MISMATCH_COUNT=$(grep -c "^##" reports/seo-canonical-mismatches.md || echo "0")
            echo "- Canonical mismatches detected: $MISMATCH_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìé **Reports:** Check artifacts for detailed findings" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seo-reports-${{ github.run_id }}
          path: reports/
          retention-days: 30

